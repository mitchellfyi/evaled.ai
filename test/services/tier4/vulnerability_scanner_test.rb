# frozen_string_literal: true

require "test_helper"
require "webmock/minitest"

module Tier4
  class VulnerabilityScannerTest < ActiveSupport::TestCase
    setup do
      @agent = create(:agent, repo_url: "https://github.com/testowner/testrepo")
      @scanner = VulnerabilityScanner.new
      WebMock.enable!
      stub_default_github_apis
    end

    teardown do
      WebMock.disable!
    end

    test "scan creates SecurityScan record" do
      assert_difference -> { SecurityScan.count }, 1 do
        @scanner.scan(@agent)
      end
    end

    test "scan creates record belonging to agent" do
      scan = @scanner.scan(@agent)

      assert_equal @agent.id, scan.agent_id
    end

    test "scan sets scan_type to full" do
      scan = @scanner.scan(@agent)

      assert_equal "full", scan.scan_type
    end

    test "scan sets scanned_at" do
      scan = @scanner.scan(@agent)

      assert scan.scanned_at.present?
      assert scan.scanned_at <= Time.current
    end

    test "scan passes with no critical or high findings" do
      scan = @scanner.scan(@agent)

      assert scan.passed
    end

    test "scan fails with critical findings" do
      stub_dependabot_alerts(severity: "critical")

      scan = @scanner.scan(@agent)

      assert_not scan.passed
    end

    test "scan fails with high findings" do
      stub_dependabot_alerts(severity: "high")

      scan = @scanner.scan(@agent)

      assert_not scan.passed
    end

    test "severity_counts tracks all severities" do
      scan = @scanner.scan(@agent)

      assert scan.severity_counts.key?("critical")
      assert scan.severity_counts.key?("high")
      assert scan.severity_counts.key?("medium")
      assert scan.severity_counts.key?("low")
      assert scan.severity_counts.key?("unknown")
    end

    # Dependency scanning tests
    test "scan_dependencies returns findings from dependabot" do
      stub_dependabot_alerts(count: 2, severity: "high")

      findings = @scanner.scan_dependencies(@agent)

      assert_equal 2, findings.size
      assert findings.all? { |f| f[:type] == "dependency" }
    end

    test "scan_dependencies handles no alerts" do
      stub_request(:get, %r{api.github.com/repos/.*/dependabot/alerts})
        .to_return(status: 200, body: [].to_json)

      findings = @scanner.scan_dependencies(@agent)

      assert_empty findings
    end

    test "scan_dependencies handles non-array response" do
      stub_request(:get, %r{api.github.com/repos/.*/dependabot/alerts})
        .to_return(status: 200, body: { message: "Not Found" }.to_json)

      findings = @scanner.scan_dependencies(@agent)

      assert_empty findings
    end

    test "scan_dependencies returns empty for no repo_url" do
      agent = create(:agent, repo_url: nil)

      findings = @scanner.scan_dependencies(agent)

      assert_empty findings
    end

    # Code scanning tests
    test "scan_code detects sql injection pattern" do
      stub_code_content("app/controllers/application_controller.rb", 'execute("SELECT * FROM users WHERE id = #{params[:id]}")')

      findings = @scanner.scan_code(@agent)

      assert findings.any? { |f| f[:vulnerability].include?("Sql injection") }
    end

    test "scan_code detects command injection pattern" do
      stub_code_content("app/controllers/application_controller.rb", 'system("ls #{user_input}")')

      findings = @scanner.scan_code(@agent)

      assert findings.any? { |f| f[:vulnerability].include?("Command injection") }
    end

    test "scan_code detects eval usage" do
      stub_code_content("app/controllers/application_controller.rb", "eval(user_input)")

      findings = @scanner.scan_code(@agent)

      assert findings.any? { |f| f[:vulnerability].include?("Eval usage") }
    end

    test "scan_code detects unsafe YAML.load" do
      stub_code_content("app/controllers/application_controller.rb", "YAML.load(file_content)")

      findings = @scanner.scan_code(@agent)

      assert findings.any? { |f| f[:vulnerability].include?("Unsafe yaml") }
    end

    test "scan_code detects mass assignment" do
      stub_code_content("app/controllers/application_controller.rb", "User.create(params.permit!)")

      findings = @scanner.scan_code(@agent)

      assert findings.any? { |f| f[:vulnerability].include?("Mass assignment") }
    end

    # Secret scanning tests
    test "scan_secrets detects AWS keys" do
      stub_code_content(".env.example", "AWS_KEY=AKIAIOSFODNN7EXAMPLE")

      findings = @scanner.scan_secrets(@agent)

      assert findings.any? { |f| f[:secret_type].include?("Aws key") }
    end

    test "scan_secrets detects GitHub tokens" do
      stub_code_content(".env.example", "GITHUB_TOKEN=ghp_1234567890abcdefghijklmnopqrstuvwxyz12")

      findings = @scanner.scan_secrets(@agent)

      assert findings.any? { |f| f[:secret_type].include?("Github token") }
    end

    test "scan_secrets detects OpenAI keys" do
      stub_code_content(".env.example", "OPENAI_KEY=sk-1234567890abcdefghijklmnopqrstuvwxyz123456789012")

      findings = @scanner.scan_secrets(@agent)

      assert findings.any? { |f| f[:secret_type].include?("Openai key") }
    end

    test "scan_secrets detects private keys" do
      stub_code_content(".env.example", "-----BEGIN RSA PRIVATE KEY-----")

      findings = @scanner.scan_secrets(@agent)

      assert findings.any? { |f| f[:secret_type].include?("Private key") }
    end

    test "scan_secrets detects JWT tokens" do
      stub_code_content(".env.example", "TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIn0.dozjgNryP4J3jVmNHl0w5N_XgL0n3I9PlFUP0THsR8U")

      findings = @scanner.scan_secrets(@agent)

      assert findings.any? { |f| f[:secret_type].include?("Jwt token") }
    end

    # Container scanning tests
    test "scan_container detects latest tag" do
      stub_dockerfile("FROM ruby:latest\nRUN bundle install")

      findings = @scanner.scan_container(@agent)

      assert findings.any? { |f| f[:vulnerability].include?("Unpinned base image") }
    end

    test "scan_container detects running as root" do
      stub_dockerfile("FROM ruby:3.2\nRUN bundle install")

      findings = @scanner.scan_container(@agent)

      assert findings.any? { |f| f[:vulnerability].include?("Running as root") }
    end

    test "scan_container detects unsafe script execution" do
      stub_dockerfile("FROM ruby:3.2\nRUN curl https://example.com/script.sh | sh")

      findings = @scanner.scan_container(@agent)

      assert findings.any? { |f| f[:vulnerability].include?("Unsafe script execution") }
    end

    test "scan_container returns empty when no Dockerfile" do
      stub_request(:get, %r{api.github.com/repos/.*/contents/Dockerfile})
        .to_return(status: 404)

      findings = @scanner.scan_container(@agent)

      assert_empty findings
    end

    # count_severities tests
    test "count_severities counts each severity" do
      findings = [
        { severity: "critical" },
        { severity: "critical" },
        { severity: "high" },
        { severity: "medium" },
        { severity: "low" },
        { severity: "unknown" }
      ]

      counts = @scanner.count_severities(findings)

      assert_equal 2, counts[:critical]
      assert_equal 1, counts[:high]
      assert_equal 1, counts[:medium]
      assert_equal 1, counts[:low]
      assert_equal 1, counts[:unknown]
    end

    test "count_severities handles empty findings" do
      counts = @scanner.count_severities([])

      assert_equal 0, counts[:critical]
      assert_equal 0, counts[:high]
    end

    test "count_severities handles nil severity" do
      findings = [ { severity: nil } ]

      counts = @scanner.count_severities(findings)

      assert_equal 1, counts[:unknown]
    end

    private

    def stub_default_github_apis
      stub_request(:get, %r{api.github.com/repos/.*/dependabot/alerts})
        .to_return(status: 200, body: [].to_json)

      stub_request(:get, %r{api.github.com/repos/.*/contents/})
        .to_return(status: 404)
    end

    def stub_dependabot_alerts(count: 1, severity: "medium")
      alerts = count.times.map do
        {
          state: "open",
          security_vulnerability: {
            package: { name: "vulnerable-package" },
            severity: severity
          },
          security_advisory: {
            summary: "Test vulnerability",
            cve_id: "CVE-2024-1234"
          },
          html_url: "https://github.com/alerts/1"
        }
      end

      stub_request(:get, %r{api.github.com/repos/.*/dependabot/alerts})
        .to_return(status: 200, body: alerts.to_json)
    end

    def stub_code_content(path, content)
      stub_request(:get, %r{api.github.com/repos/.*/contents/#{Regexp.escape(path)}})
        .to_return(
          status: 200,
          body: { content: Base64.encode64(content) }.to_json,
          headers: { "Content-Type" => "application/json" }
        )
    end

    def stub_dockerfile(content)
      stub_request(:get, %r{api.github.com/repos/.*/contents/Dockerfile})
        .to_return(
          status: 200,
          body: { content: Base64.encode64(content) }.to_json,
          headers: { "Content-Type" => "application/json" }
        )
    end
  end
end
